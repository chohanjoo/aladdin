# Aladdin 


### Introduction


Aladdin provide Network Visualization & Kubernetes Monitoring
:imagedir: ./img
image::{imagedir}/aladdin-infrastructure.png[Aladdin Infrastructure, width=800]

### Getting Started

    # install helm
    curl https://raw.githubusercontent.com/kubernetes/helm/master/scripts/get > install-helm.sh
    chmod u+x install-helm.sh
    ./install-helm.sh
    kubectl -n kube-system create serviceaccount tiller
    kubectl create clusterrolebinding tiller --clusterrole cluster-admin --serviceaccount=kube-system:tiller
    helm init --service-account tiller

    # download istio
    git clone https://github.com/soda-infra/istio
    cd istio
    git checkout release-1.2
    
    # install istio-init
    helm install install/kubernetes/helm/istio-init --name istio-init --namespace istio-system
   
    # verify istio-init (아래 명령 결과가 23이 나오면 완료)
    kubectl get crds | grep 'istio.io\|certmanager.k8s.io' | wc -l
    
    # kiali secret 생성 (username: admin, password: admin)
    cat <<EOF | kubectl apply -f -
    apiVersion: v1
    kind: Secret
    metadata:
      name: kiali
      namespace: istio-system
      labels:
        app: kiali
    type: Opaque
    data:
      username: YWRtaW4=
      passphrase: YWRtaW4=
    EOF
    
    # install istio
    helm install install/kubernetes/helm/istio \
    --name istio \
    --namespace istio-system \
    --set tracing.enabled=true \
    --set global.mtls.enabled=true \
    --set grafana.enabled=true \
    --set kiali.enabled=true \
    --set servicegraph.enabled=true
    
    # install aladdin-requirements
    git clone https://github.com/soda-infra/aladdin-requirements
    helm install aladdin-requirements --name aladdin-requirements
    
    # loading istio example
    kubectl label namespace default istio-injection=enabled
    kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml
    kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml
    export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="http2")].nodePort}')
    export SECURE_INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="https")].nodePort}')
    export INGRESS_HOST=$(kubectl get po -l istio=ingressgateway -n istio-system -o jsonpath='{.items[0].status.hostIP}')
    export GATEWAY_URL=$INGRESS_HOST:$INGRESS_PORT
    kubectl apply -f samples/bookinfo/networking/destination-rule-all-mtls.yaml
    
    # verify
    curl -s http://${GATEWAY_URL}/productpage | grep -o "<title>.*</title>"
    
    # check kiali port (kiali 포트로 접속)
    kubectl get svc -A
    
    # make traffic
    cat >> ~/makeTraffic.sh <<EOF
    for ((i=1;i<=10000000;i++)); do
        curl -v --header "Connection: keep-alive" "http://127.0.0.1:31380/productpage";
        sleep 5;
    done
    EOF 
    sudo chmod +x makeTraffic.sh


### License


Apache License 2.0
